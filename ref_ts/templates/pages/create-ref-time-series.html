{% extends "pages/page.html" %}

{% load mezzanine_tags pages_tags hydroshare_tags staticfiles%}

{% block title %}

    Add HIS Reference Metadata for <i>{{ title }}</i> resource

{% endblock %}

{% block main %}

    <h2>Add HIS Reference Metadata for the <i>{{ title }}</i> resource</h2>

    <form class="form-horizontal" role="form" method="POST" enctype="multipart/form-data" action="/hsapi/_internal/create-ref-time-series/">
        {% csrf_token %}



        <h3>Link to your Time Series:</h3>
        <div class="form-group has-feedback" id="url-input">
            <label for="" class="col-sm-2 control-label">HIS URL</label>
            <div class="col-sm-10">
                <input type="text" class="form-control" name="url" id="url" placeholder="www.example.org.asmx?WSDL" aria-describedby="inputSuccess">
            </div>
        </div>

        <div class="col-sm-offset-2 col-sm-10" id="loading-1">
            <h3 id="loading-1-text">Retrieving sites...</h3>
        </div>


        <div class="form-group cuahsi-his cuahsi-his-2">
            <label for="" class="col-sm-2 control-label">Site from Server</label>
            <div class="col-sm-10">
                <select class="form-control" name="site" id="site"></select>
            </div>
        </div>

        <div class="col-sm-offset-2 col-sm-10" id="loading-2">
            <h3 id="loading-2-text">Retrieving variables...</h3>
        </div>


        <div class="form-group cuahsi-his cuahsi-his-3">
            <label for="" class="col-sm-2 control-label">Variable</label>
            <div class="col-sm-10">
                <select class="form-control" name="variable" id="variable"></select>
            </div>
        </div>

        <div class ="form-group" id ="preview-div" class="col-sm-offset-2 col-sm-10">

        </div>

        <div class="form-group" id="fail-notice">
            <div class="col-sm-offset-2 col-sm-10">
                <h3>Invalid Data! </h3>
                <h5>This data failed to validate, which probably means that the WaterML document is not correctly formatted. This time series cannot be used to create a resource </h5>
            </div>
        </div>


        <div class="form-group">
            <div class="col-sm-offset-2 col-sm-10">
                <button type="submit" id="submit" class="btn btn-primary btn-lg btn-block disabled">Add HIS Time Series</button>
            </div>
        </div>

        <div class="form-group" id="metadata" style="display: none;">
            <div class="col-sm-offset-2 col-sm-10">
                <input type="text" class="btn btn-primary btn-lg btn-block" name='metadata' value='{{ metadata }}'>
            </div>
        </div>

        <div class="form-group" id="title" style="display: none;">
            <div class="col-sm-offset-2 col-sm-10">
                <input type="text" class="btn btn-primary btn-lg btn-block" name='title' value='{{ title }}'>
            </div>
        </div>



    </form>

{% endblock %}

{% block extra_js %}
    <link rel="stylesheet" href="../../static/ref_ts/rickshaw/rickshaw.min.css">
    <script src=" {% static "ref_ts/rickshaw/vendor/d3.min.js" %}"></script>
    <script src=" {% static "ref_ts/rickshaw/vendor/d3.layout.min.js" %}"></script>
    <script src=" {% static "ref_ts/rickshaw/rickshaw.min.js" %}"></script>
    <script type="text/javascript">
        $(function() {

            $(document).ready(function(){
                $('#preview-div').hide();
                $('#fail-notice').hide();
                $('.cuahsi-his').hide();
                $('#loading-1').hide();
                $('#loading-2').hide();
            });


            $('#url').on('input', function(){
                $('#url-input').removeClass("has-success");
                $('#url-input').removeClass("has-error");
                $('#fail-notice').hide();
                $('#loading-1-text').html('<h3></h3>');

                var url = $('#url').val();
                if (url.match(/WSDL$/) || url.match(/wsdl$/)){
                    $('.cuahsi-his-1').show();
                    $('#preview-div').html( '<div class="col-sm-offset-2" id="preview"></div>');
                    get_sites(url);
                }
                else {
                    $('#loading-1').show();
                    $('.cuahsi-his').hide();
                    $.ajax({
                        type: "GET",
                        url: '/hsapi/_internal/verify-rest-url/',
                        data: {url: $('#url').val()},
                        success: function (data, xhr, status) {
                            if (data == 200) {
                                $('#url-input').addClass("has-success");
                            getVals('rest');
                            }
                            else if (data == 400 || data == 404) {
                                $('#loading-1-text').html('<h3>URL did not verify. There may be a problem with the URL you entered</h3>');
                                $('#url-input').removeClass("has-success");
                                $('#url-input').addClass("has-error");
                            }

                        },
                        error: function(){
                            $('#url-input').removeClass("has-success");
                            $('#url-input').addClass("has-error");
                        }
                    });
                }

                var b = $('#verify-rest-button');
                b.html('Verify');
                b.removeClass('btn-danger');
                b.removeClass('btn-success');
                $('#preview-div').hide();
                $('#fail-notice').hide();
                var b = $('#submit');
                b.addClass('disabled');
            });


            function removeOptions(selectbox){
                var i;
                for(i=selectbox.options.length-1;i>=0;i--)
                {
                    selectbox.remove(i);
                }
            }

            function compare(a,b) {
                if (a.x < b.x)
                    return -1;
                if (a.x > b.x)
                    return 1;
                return 0;
            }

            function get_sites(url){
                $('#loading-1').show();
                $('#loading-1-text').html('<h3>Retrieving Sites...</h3>');
                $.ajax({
                    type:"GET",
                    url:'/hsapi/_internal/search-sites/',
                    data: {url: url},
                    success: function(data, xhr, status){
                        var select = document.getElementsByName('site')[0];
                        removeOptions(select);
                        for(var site in data) {
                            var ln = (data[site]);
                            var opt = document.createElement('option');
                            opt.value = ln;
                            opt.innerHTML = ln;
                            select.appendChild(opt);
                            $('.cuahsi-his-2').show();
                            $('#loading-1').hide();
                        }
                    },
                    error: function(data, stuff){
                        $('#loading-1').
                                console.log(data);
                        console.log(stuff);
                    }
                }).always(function () {btn.button('reset')});
            }

            function get_variables(site){
                $('#loading-2').show();
                var n = site.indexOf(':'),
                        site_code = site.substr(n+2);
                var url = $('#url').val();
                $.ajax({
                    type:"GET",
                    url:'/hsapi/_internal/search-variables/',
                    data: {url: url,
                        site: site_code},
                    success: function(data, xhr, status){
                        $('.cuahsi-his-3').show();
                        var select = document.getElementsByName('variable')[0];
                        removeOptions(select);
                        for(var index in data) {
                            var ln = ( data[index]);
                            var opt = document.createElement('option');
                            opt.value = ln;
                            opt.innerHTML = ln;
                            select.appendChild(opt);
                            if (data.length == 1){
                                getVals('soap');
                            }
                        }
                        $('#loading-2').hide();
                    },
                    error: function(data, stuff) {
                        console.log(data);
                        console.log(stuff);

                    }
                })
            }


            function getVals(ref_type) {
                $('#preview-div').html('<h2 class="col-sm-offset-2 col-sm-10">Retrieving Data . . .</h2>');
                $('#preview-div').show();
                if (ref_type == 'rest') {
                    var service_url = $('#url').val(),
                            site,
                            variable;
                }
                else {
                    service_url = $('#url').val();
                    var full_site = $('#site').val();
                    var n = full_site.indexOf(':');
                    site = full_site.substr(n+2);
                    var full_variable = $('#variable').val();
                    n = full_variable.indexOf(':');
                    variable = full_variable.substr(n+2);
                }
                $.ajax({
                    type:"GET",
                    url:'/hsapi/_internal/time-series-from-service/',
                    data: {ref_type: ref_type,
                        service_url: service_url,
                        site: site,
                        variable: variable},
                    success: function(data, xhr, status){
                        var vis_file_name = data['vis_file_name'];
                        $('#preview-div').html('<img src="{{ STATIC_URL }}img/'+vis_file_name+'" id="preview-graph" class="col-sm-offset-2"/>');
                        $('#preview-div').show();
                        var b = $('#submit');
                        b.removeClass('disabled');
                        $('#loading-1').hide();
                    },
                    error: function(data, stuff){
                        $('#url-input').removeClass("has-success")
                        $('#fail-notice').show();
                        console.log(data);
                        console.log(stuff);
                        $('#preview-div').hide();
                        $('#loading-1').hide();
                    }
                })
            }

            $('#variable').change(function(){
                $('#fail-notice').hide();
                var b = $('#submit');
                b.addClass('disabled');
                getVals('soap');

            });

            $('#site').change(function(){
                $('.cuahsi-his-3').hide();
                var site = $('#site').val();
                get_variables(site);
                $('#preview-div').hide();
                $('#fail-notice').hide();
                var select = $('#variable');
                removeOptions(select);
                var b = $('#preview-button-soap');
                b.addClass('disabled');
                var b = $('#submit');
                b.addClass('disabled');
            });
        });
    </script>
{% endblock %}

