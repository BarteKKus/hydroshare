{% extends "base.html" %}
{% load geoanalytics_tags pages_tags mezzanine_tags keyword_tags comment_tags hydroshare_tags %}
{% block title %}Discovery{% endblock %}
{% block main %}
<div class="container-fluid" id="main">
    <div class="row">
        <div class="col-lg-3" id="folders">
            {% if query %}
                <input class="btn btn-default" type="button" value="Clear All" style="margin-bottom: 10px" onclick="clearAllFaceted()">
                {% for key, values in facets.fields.items %}
                    {% if values %}
                        <div class="panel-group" id="faceting-{{ key }}">
                            <div class="panel panel-default">
                                <div class="panel-heading">
                                <h4 class="panel-title">
                                    <a data-toggle="collapse" href="#{{ key }}">
                                        {% if key == 'author'%}
                                            &nbsp; Filter by Author
                                        {% elif key ==  'subjects'%}
                                            &nbsp; Filter by Subject
                                        {% elif key ==  'resource_type'%}
                                            &nbsp; Filter by Resource Type
                                        {% elif key ==  'public'%}
                                            &nbsp; Filter by Public
                                        {% elif key ==  'owners_names'%}
                                            &nbsp; Filter by Owner
                                        {% elif key ==  'discoverable'%}
                                            &nbsp; Filter by Discoverable
                                        {% endif %}
                                        <span
                                            {% if key == 'author' or key == 'subjects' or key == 'resource_type'%}
                                                class="glyphicon glyphicon-minus pull-left"
                                            {% else %}
                                                class="glyphicon glyphicon-plus pull-left"
                                            {% endif %}>
                                        </span>
                                    </a>
                                </h4>
                                </div>
                                <div id="{{ key }}"
                                     {% if key == 'author' or key == 'subjects' or key == 'resource_type'%}
                                        class="panel-collapse collapse in"
                                     {% else %}
                                        class="panel-collapse collapse"
                                     {% endif %}>
                                    <ul class="list-group">
                                    {% for item in values %}
                                        {% if item.1 > 0 %}
                                            <li class="list-group-item">
                                                <input class="faceted-selections" id="{{ key }}-{{ item.0 }}" value="{{ key }},{{ item.0 }}" type="checkbox" class="pull-left"> &nbsp;&nbsp; {{ item.0 }}
                                                    {% if item.1 >= 1 and item.1 < 2 %}
                                                        <span class="label label-default label-pill pull-right badge YellowGreenBlue-colormap-band-9">
                                                    {% elif item.1 >= 2 and item.1 <= 4 %}
                                                        <span class="label label-default label-pill pull-right badge YellowGreenBlue-colormap-band-9">
                                                    {% elif item.1 > 4 and item.1 <= 6 %}
                                                        <span class="label label-default label-pill pull-right badge YellowGreenBlue-colormap-band-8">
                                                    {% elif item.1 > 6 and item.1 <= 10 %}
                                                        <span class="label label-default label-pill pull-right badge YellowGreenBlue-colormap-band-7">
                                                    {% elif item.1 > 10 and item.1 <= 18 %}
                                                        <span class="label label-default label-pill pull-right badge YellowGreenBlue-colormap-band-6">
                                                    {% elif item.1 > 18 and item.1 <= 32 %}
                                                        <span class="label label-default label-pill pull-right badge YellowGreenBlue-colormap-band-5">
                                                    {% elif item.1 > 32 and item.1 <= 57 %}
                                                        <span class="label label-default label-pill pull-right badge YellowGreenBlue-colormap-band-4">
                                                    {% elif item.1 > 57 and item.1 <= 100 %}
                                                        <span class="label label-default label-pill pull-right badge YellowGreenBlue-colormap-band-3">
                                                    {% elif item.1 > 100 and item.1 <= 178 %}
                                                        <span class="label label-default label-pill pull-right badge YellowGreenBlue-colormap-band-2">
                                                    {% elif item.1 > 178 %}
                                                        <span class="label label-default label-pill pull-right badge YellowGreenBlue-colormap-band-1">
                                                    {% endif %}{{ item.1 }}
                                                </span>
                                            </li>
                                        {% endif %}
                                    {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}
            {% endif %}
        </div>
        <div class="col-lg-9" id="items">
            {% if not query %}
                <h4>Enter a search term to find resources on HydroShare</h4>
            {% endif %}
            <div class=resource-search>
                <form id="search-field" method="get" action=".">
                    {% for field in form %}
                        <div class="fieldWrapper">
                            {{ field }}
                        </div>
                    {% endfor %}
                </form>
            </div>

            {% if query %}
                <ul id="switch-view" class="nav nav-tabs">
                    <li class="active"><a href="#list-view">List</a></li>
                    <li><a href="#map-view">Map</a></li>
                </ul>
                <div class="tab-content">
                    <div id="list-view" class="tab-pane fade in active">
                        <table class="table table-striped table-hover" id="items-discovered">
                            <tr>
                                <th>Title</th>
                                <th>Type</th>
                                <th>First Author</th>
                                <th>Last Modified</th>
                                <th>east</th>
                            </tr>
                            {% for result in page_obj.object_list %}
                                <tr>
                                    <td><a href="{{ result.object.get_absolute_url }}">{{ result.object.title }}</a></td>
                                    <td>{{ result.object|resource_type }}</td>
                                    {% if result.object.first_creator.description %}
                                        <td><a href="{{ result.object.first_creator.description }}">{{ result.object.first_creator.name  }}</a></td>
                                    {% else %}
                                        <td>{{ result.object.first_creator.name }}</td>
                                    {% endif %}
                                    <td>{{ result.object.updated|date }} {{ result.object.updated|time }}</td>
                                <!--
                                    {% for coverage in result.object.metadata.coverages.all %}
                                        {% if coverage.type == 'point' %}
                                            <td> east:{{ coverage.value.east }} </td>
                                        {% elif coverage.type == 'box' %}
                                            <td> limit:{{ coverage.value.eastlimit }} </td>
                                        {% endif %}
                                    {% endfor %}-->
                                </tr>
                            {% empty %}
                                <p>No results found.</p>
                            {% endfor %}
                        </table>
                        {% if page_obj.has_previous or page_obj.has_next %}
                            <div style="float: right">
                                {% if page_obj.has_previous %}<a href="?q={{ query }}&amp;page={{ page_obj.previous_page_number }}">{% endif %}&laquo; Previous{% if page_obj.has_previous %}</a>{% endif %}
                                |
                                {% if page_obj.has_next %}<a href="?q={{ query }}&amp;page={{ page_obj.next_page_number }}">{% endif %}Next &raquo;{% if page_obj.has_next %}</a>{% endif %}
                            </div>
                        {% endif %}
                    </div>
                    <div id="map-view" class="tab-pane fade">
                        <div id="discover-map" style="width: 1000px;height: 1000px"></div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}

    <script type="text/javascript">
        var json_results = [];
        var markers = [];

        var map = null;
        //var bounds = new google.maps.LatLngBounds();
        //var info_window = new google.maps.InfoWindow();
        var initMap = function() {
            var bounds = new google.maps.LatLngBounds();
           // var myLatLng = {lat: 37.4419, lng: -122.1419};
           /* var infowindow = new google.maps.InfoWindow({
                content: 'resource 1'
            });*/
            map = new google.maps.Map(document.getElementById('discover-map'), {
                zoom: 2,
                mapTypeId: google.maps.MapTypeId.TERRAIN
               // center: myLatLng
            });



            //var info_content = [];
            var info_window = new google.maps.InfoWindow();
            //var rectangle
            for(var  i = 0; i < json_results.length; i++ ) {
                //var data = json_results[i];
                if(json_results[i].coverage_type == 'point') {
                    var lat = parseFloat(json_results[i].north);
                    var lng = parseFloat(json_results[i].east);
                    var position = new google.maps.LatLng(lat, lng);

                    //var latlng = {lat: parseFloat(data.north), lng: parseFloat(data.east)};
                }else if(json_results[i].coverage_type == 'box'){
                    var lat = (parseFloat(json_results[i].northlimit) + parseFloat(json_results[i].southlimit)) / 2;
                    var lng = (parseFloat(json_results[i].eastlimit) + parseFloat(json_results[i].westlimit)) / 2;
                    var position = new google.maps.LatLng(lat, lng);
                    /*info_window = new google.maps.InfoWindow();
                    rectangle = new google.maps.Rectangle({
                        strokeColor: '#FF0000',
                        strokeOpacity: 0.8,
                        strokeWeight: 2,
                        fillColor: '#FF0000',
                        fillOpacity: 0.35,
                        map: map,
                        bounds: {
                            north: parseFloat(json_results[i].northlimit),
                            south: parseFloat(json_results[i].southlimit),
                            east: parseFloat(json_results[i].eastlimit),
                            west: parseFloat(json_results[i].westlimit)
                        }
                    });

                    var link = json_results[i].get_absolute_url;
                    var title = json_results[i].title;
                    var info_content = '"<a href="' + json_results[i].get_absolute_url + '">' + json_results[i].title + '</a>';
                    google.maps.event.addListener(rectangle, 'click', function() {
                        var ne = rectangle.getBounds().getNorthEast();
                        info_window.setContent(info_content);
                        info_window.setPosition(ne);
                        info_window.open(map);

                    });*/
                }else{
                    continue;
                }

                    var link = json_results[i].get_absolute_url;
                    var title = json_results[i].title;
                    var info_content = '"<a href="' + json_results[i].get_absolute_url + '">' + json_results[i].title + '</a>';
                    createMarker(position, info_content, bounds, info_window,json_results[i].coverage_type);

            }

            map.fitBounds(bounds);
            /*var marker = new google.maps.Marker({
                position: myLatLng,
                map: map,
                title: 'Hello World!'
            });*/
            //(optional) restore the zoom level after the map is done scaling
            var listener = google.maps.event.addListener(map, "idle", function () {
                map.setZoom(2);
                google.maps.event.removeListener(listener);
            });


            /*marker.addListener('click', function() {
                //map.setZoom(8);
                map.setCenter(marker.getPosition());
                infowindow.open(marker.get('map'), marker);
            });*/
            //google.maps.event.addListenerOnce(map, 'idle', function() {map.fitBounds(bounds);});
        }

        function createMarker(latlng, info_content, bounds, info_window, type) {
            if(type == 'box') {
                var marker = new google.maps.Marker({
                    map: map,
                    icon: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png',
                    position: latlng
                });
            }else if(type == 'point'){
                var marker = new google.maps.Marker({
                    map: map,
                    position: latlng
                });
            }
            google.maps.event.addListener(marker, 'click', function() {
                info_window.setContent(info_content);
                info_window.open(map, marker);
            });
            bounds.extend(latlng);
        }
        var reorderDivs = function() {
            var faceted_fields = ['author', 'subjects', 'resource_type', 'public', 'owners_names', 'discoverable'];
            var div_ordering = [];
            faceted_fields.forEach(function(field){
                var faceting_div = "faceting-"+field;
                div_ordering.push(faceting_div);
            });
            var i;
            for (i = 1; i < div_ordering.length; i++) {
                var div0 = "#" + div_ordering[i-1];
                var div1 = "#" + div_ordering[i];
                $(div1).insertAfter(div0);
            }
        }

        var clearAllFaceted = function() {
            localStorage.clear();
            var textSearch = $("#id_q").val();
            var clearURL = "/search/?q=" + textSearch;
            window.location = clearURL;
        }

        $(document).ready(function () {
            //console.log(res);
            //google.maps.event.addDomListener(window, 'load', initMap);
            //var titles = [];
            if($("#id_q").val() == ''){
                //initMap();
                $("#search-results").hide();
            }
            $("ul.nav-tabs > li > a").on("shown.bs.tab", function (e) {
                var tabId = $(e.target).attr("href").substr(1);
                window.location.hash = tabId;
                if(tabId == 'map-view'){
                    $.ajax({
                        type: "GET",
                        url: "/searchjson",
                        dataType: 'json'
                        , data: {
                            'q': $("#id_q").val(),
                        }
                        , success: function(data) {
                            //alert("hi");
                            $("#search-results").show();
                            //data = $.parseJSON(data);
                            //console.log(data);
                            console.log("success");
                            //console.log(data);
                            for(var j = 0; j < data.length; j++){
                                var item = $.parseJSON(data[j]);
                                json_results.push(item);
                            }
                            console.log(json_results);
                            initMap();
                            /*$.each(data, function(index, item){
                                    item = $.parseJSON(item);
                                    console.log(index + " : " + item);
                            });*/

                            /*$.each( data, function( i, l ) {
                                json_results.push(l);
                            });

                            for(var k = 0; k < json_results.length; k++){
                                console.log(json_results[k]);
                            }*/

                        }
                        , failure: function(data){
                            console.log("fail");
                        }
                    });
                }
            });
            $(".nav-tabs a").click(function(){
                $(this).tab('show');
            });

            // on load of the page: switch to the currently selected tab
            var hash = window.location.hash;
            $('#switch-view a[href="' + hash + '"]').tab('show');

            $("#id_q").attr('placeholder', 'Search...');
            reorderDivs();

            $('.collapse').on('shown.bs.collapse', function(){
                $(this).parent().find(".glyphicon-plus").removeClass("glyphicon-plus").addClass("glyphicon-minus");
            }).on('hidden.bs.collapse', function(){
                $(this).parent().find(".glyphicon-minus").removeClass("glyphicon-minus").addClass("glyphicon-plus");
            });

            $("#id_q").keypress(function(event) {
                if (event.which == 13) {
                    event.preventDefault();
                    localStorage.clear();
                    $("#search-field").submit();
                }
            });
            $(".faceted-selections").click(function () {
                var tokens = $(this).val().split(",");
                var key = tokens[0];
                var value = tokens[1];
                var textSearch = $("#id_q").val();
                var searchURL = "?q=" + textSearch;
                var windowPath = window.location.pathname;
                var requestURL =  windowPath + searchURL;

                if($(this).is(":checked")) {
                    requestURL = requestURL + "&selected_facets="+key+"_exact:"+value
                    $(".faceted-selections").each(function () {
                        var val = localStorage[$(this).attr("id")];
                        //var isChecked = val !== undefined ? val == "true" : false;
                        var isChecked = val === 'true';
                        if(isChecked){
                            var arr = $(this).val().split(",");
                            var key = arr[0];
                            var value = arr[1];
                            requestURL += "&selected_facets="+key+"_exact:"+value;
                        }
                    });
                    window.location = requestURL;
                    localStorage[$(this).attr("id")] = this.checked;
                }else{
                    localStorage.removeItem($(this).attr("id"));
                    var textSearch = $("#id_q").val();
                    var updateURL = "/search/?q=" + textSearch;
                    $(".faceted-selections").each(function () {
                        var val = localStorage[$(this).attr("id")];
                        //var isChecked = val !== undefined ? val == "true" : false;
                        var isChecked = val === 'true';
                        if(isChecked){
                            var arr = $(this).val().split(",");
                            var key = arr[0];
                            var value = arr[1];
                            updateURL += "&selected_facets="+key+"_exact:"+value;
                        }
                    });
                    window.location = updateURL;
                }
            });

            $(".faceted-selections").each(function () {
                var val = localStorage[$(this).attr("id")];
                var isChecked = val !== undefined ? val == "true" : false;
                $(this).prop("checked", isChecked);
            });

            $("#faceted-search").click(function(){
                localStorage.clear();
            });

            $(".all-rows-selector").change(function(){
                $(".row-selector").prop("checked", $(this).prop("checked"));
            });
        });
    </script>
{% endblock %}