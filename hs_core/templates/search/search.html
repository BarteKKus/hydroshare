{% extends "base.html" %}

{# {% block title %}{{ user|best_name }}'s Resources{% endblock %}#}
{% block title %}Resources{% endblock %}

{% block main %}
<div class="container-fluid" id="main">
    <div class="row">
        <div class="col-lg-3" id="folders">
             <form method="get" action=".">
                <table>
                    <tbody>
                        {{ form.as_table }}
                        <tr>
                            <td>&nbsp;</td>
                            <td><input id="faceted-search" type="submit" value="Search"></td>
                        </tr>
                    </tbody>
                </table>
            </form>
            {% for key, values in facets.fields.items %}
                {% if values %}
                    <div class="panel-group" id="faceting-{{ key }}">
                        <div class="panel panel-default">
                            <div class="panel-heading">
                            <h4 class="panel-title">
                                <a data-toggle="collapse" href="#{{ key }}">Filter By {{ key }}</a>
                            </h4>
                            </div>
                            <div id="{{ key }}"
                                 {% if key == 'author' or key == 'subjects' or key == 'resource_type'%}
                                    class="panel-collapse collapse in"
                                 {% else %}
                                    class="panel-collapse collapse"
                                 {% endif %}>
                                <ul class="list-group">
                                {% for item in values %}
                                    <li class="list-group-item">
                                        <input class="faceted-selections" id="{{ item.0 }}" value="{{ key }},{{ item.0 }}" type="checkbox" class="pull-left"> &nbsp;&nbsp; {{ item.0 }}
                                        <span class="label label-default label-pill pull-right"
                                            {% if item.1 < 5 %}
                                                style="background-color:#3333FF" class="badge"
                                            {% elif item.1 >= 5 and item.1 < 10 %}
                                                style="background-color:#CCFF00" class="badge"
                                            {% elif item.1 >= 10 %}
                                                style="background-color:#FF0000" class="badge"
                                            {% endif %}>{{ item.1 }}
                                        </span>
                                        {#<a href="{{ request.get_full_path }}&amp;selected_facets={{ key }}_exact:{{ item.0|urlencode }}">{{ item.0 }}</a>#}
                                    </li>
                                {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>
                {% endif %}
            {% endfor %}

        </div>
        <div class="col-lg-9" id="items">
            <table class="table table-striped table-hover" id="item-selectors">
                <tr>
                </tr>
                <tr>
                    <th>Title</th>
                    <th>Type</th>
                    <th>First Author</th>
                    <th>Last Modified</th>
                </tr>
                {% if query %}
                    {% for result in page.object_list %}
                        <tr>
                            <td><a href="{{ result.object.get_absolute_url }}">{{ result.object.title }}</a></td>
                            <td>{{ result.object.resource_type }}</td>
                            {% if result.object.first_creator.description %}
                            <td><a href="{{ result.object.first_creator.description }}">{{ result.object.first_creator.name  }}</a></td>
                            {% else %}
                                <td>{{ result.object.first_creator.name }}</td>
                            {% endif %}
                            <td>{{ result.object.updated|date }} {{ result.object.updated|time }}</td>
                        </tr>
                    {% empty %}
                    <p>Sorry, no results found.</p>
                    {% endfor %}
                {% endif %}
            </table>
        </div>
    </div>
</div>
{% endblock %}


{% block extra_js %}
    <script type="text/javascript">
    var reorderDivs = function(){
        var faceted_fields = ['author', 'subjects', 'resource_type', 'public', 'creators', 'discoverable', 'language'];
         var div_ordering = [];
         faceted_fields.forEach(function(field){
             var faceting_div = "faceting-"+field;
             div_ordering.push(faceting_div);
         });
         var i;
         for (i = 1; i < div_ordering.length; i++) {
             var div0 = "#" + div_ordering[i-1];
             var div1 = "#" + div_ordering[i];
             $(div1).insertAfter(div0);
         }
    }

     $(document).ready(function () {
         reorderDivs();
         $(function () {
             $(".faceted-selections").click(function () {
                console.log($(this).val());
                var tokens = $(this).val().split(",");
                var key = tokens[0];
                var value = tokens[1];
                var requestURL = "{{ request.get_full_path }}"
                if($(this).is(":checked")) {
                    window.location = requestURL + "&selected_facets="+key+"_exact:"+value;
                    //console.log(solr);
                    localStorage[$(this).attr("id")] = this.checked;
                }else{
                    localStorage.removeItem($(this).attr("id"));
                    var textSearch = $("#id_q").val();
                    console.log(textSearch);
                    var updateURL = "/search/?q=" + textSearch;
                     $(".faceted-selections").each(function () {
                         var val = localStorage[$(this).attr("id")];
                         var isChecked = val !== undefined ? val == "true" : false;
                         if(isChecked){
                             var arr = $(this).val().split(",");
                             var key = arr[0];
                             var value = arr[1];
                             updateURL += "&selected_facets="+key+"_exact:"+value;
                         }
                     });
                    window.location = updateURL;
                }
            });
            $(".faceted-selections").each(function () {
                var val = localStorage[$(this).attr("id")];
                var isChecked = val !== undefined ? val == "true" : false;
                $(this).prop("checked", isChecked);
            });
        });
        $("#faceted-search").click(function(){
            //localStorage = [];
            window.localStorage.clear();
        });
    });
    </script>
{% endblock %}