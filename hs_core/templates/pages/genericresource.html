{% extends 'pages/page.html' %}

{% load geoanalytics_tags pages_tags mezzanine_tags comment_tags keyword_tags hydroshare_tags crispy_forms_tags %}

{% block main %}

{% with page.get_content_model as cm %}
{% keywords_for page as kws %}
{% set_page_permissions page %}

{% if not metadata_form %}


    <div class="custom-btn-toolbar">
        {% if page.perms.change %}
            <a id="delete"  data-toggle="modal" data-target="#delete-resource-dialog">
                <span data-toggle="tooltip" data-placement="auto" title="Delete" class="glyphicon glyphicon-remove icon-button btn-remove"></span>
            </a>
        {% endif %}


        <a id="share" href="#sharing">
            <span data-toggle="tooltip" data-placement="auto" title="Share" class="glyphicon glyphicon-share icon-button btn-share"></span>
        </a>

        {% if page.perms.change %}
        <form action="{{ cm.get_absolute_url }}" method="post">
            {% csrf_token %}
            <input name="resource-mode" type="hidden" value="edit"/>
            <button id="edit-metadata" type="submit" data-toggle="tooltip" data-placement="auto" title="Edit" class="glyphicon glyphicon-edit icon-button btn-edit"></button>
        </form>
        {% endif %}
    </div>




    <h2 class="page-title">{{ title }}</h2>

    {% if abstract%}
        <div class="content-block">
            <h3>Abstract</h3>
            <span class="abstract">{{ abstract }}</span>
        </div>
    {% endif %}

    <div class="content-block">
        <h3>How to cite</h3>
		<span id="citation-text">{{ citation }}</span>
	</div>

    <div class="content-block">
        <h3>Sharing</h3>
       <p>
           {% if rights.statement %}
                <span class="rights-text">{{ rights.statement }} </span>
           {% endif %}

           {% if rights.url %}
                <a class="rights-url" href="{{ rights.url }}">&nbsp{{ rights.url }}</a>
           {% endif %}
        </p>
        <p>
            <strong>Sharing Status:</strong>
            {% if cm.public %}
                <span>Public</span>
            {% else %}
                <span>Private</span>
            {% endif %}

            {% if cm.public %}
                <span>(This resource can be viewed and downloaded by anyone)</span>
            {% else %}
                <span>(This resource can be viewed and downloaded only by designated users or research groups)</span>
            {% endif %}
        </p>

        <div id="sharing">
            <form action="/hsapi/_internal/{{ cm.short_id }}/change-permissions/" method="POST">
                {% csrf_token %}
                {% if cm.public %}
                    <input name="t" type="hidden" value="make_private"/>
                    {% if page.perms.change %}
                        <button type="submit" class="btn btn-danger">Make private</button>
                    {% endif %}
                {% else %}
                    <input name="t" type="hidden" value="make_public"/>
                    {% if page.perms.change %}
                        <button type="submit" class="btn btn-success">Make public</button>
                    {% endif %}
                {% endif %}
            </form>

            <div style="padding-top:0.5em">
            {% if user == cm.user %}
                You are the owner of this resource.
            {% elif is_edit_user %}
                You have been given specific permission to edit this resource.
            {% elif in_edit_group %}
                Your research group(s) have been given specific permission to edit this resource.
            {% elif is_view_user %}
                You have been given specific permission to view this resource.
            {% elif in_view_group %}
                Your research group(s) have been given specific permission to view this resource.
            {% endif %}
            </div>

            {% if page.perms.change %}
            <div class="panel-group" id="accordion">
              <div class="panel panel-default">
                <div class="panel-heading">
                  <h4 class="panel-title">
                    <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne">
                      Users with full read/write permissions on this resource
                    </a>
                  </h4>
                </div>
                <div id="collapseOne" class="panel-collapse collapse">
                  <div class="panel-body">
                        <form action="/hsapi/_internal/{{ cm.short_id }}/change-permissions/" method="POST">
                            {% csrf_token %}
                            <small>Hold down "Control", or "Command" on a Mac, to select more than one.</small>
                            <select name="designees" id="owners-select" multiple class="form-control" size="{{ owners.count }}">
                                {% for u in owners %}
                                    <option value="{{ u.pk }}" selected>{{ u|best_name }} ({{ u.username }})</option>
                                {% endfor %}
                            </select>
                            <input name="t" value="owners" type="hidden"/>
                            <button type="submit" class="btn btn-primary btn-block">Update access list</button>
                        </form>
                        <form class="form-inline" action="/hsapi/_internal/{{ cm.short_id }}/change-permissions/" method="POST" style="padding-top:0.3em">
                            {% csrf_token %}
                            <div class="form-group">
                                <label for="">Add user (first, last, email, or username)</label>
                            <input name="t" value="add_owner" type="hidden"/>
                            {{ add_owner_user_form.user }}
                                <button type="submit" class="btn btn-primary">Add</button>
                            </div>

                        </form>
                  </div>
                </div>
              </div>

              <div class="panel panel-default">
                <div class="panel-heading">
                  <h4 class="panel-title">
                    <a data-toggle="collapse" data-parent="#accordion" href="#collapseTwo">
                      Users who can edit the content of this resource
                    </a>
                  </h4>
                </div>
                <div id="collapseTwo" class="panel-collapse collapse">
                  <div class="panel-body">
                    <form action="/hsapi/_internal/{{ cm.short_id }}/change-permissions/" method="POST">
                        {% csrf_token %}
                        <small>Hold down "Control", or "Command" on a Mac, to select more than one.</small>
                        <select name="designees" id="edit_users-select" multiple class="form-control" size="{{ edit_users.count }}">
                            {% for u in edit_users %}
                                <option value="{{ u.pk }}" selected>{{ u|best_name }} ({{ u.username }})</option>
                            {% endfor %}
                        </select>
                        <input name="t" value="edit_users" type="hidden"/>
                        <button type="submit" class="btn btn-primary btn-block">Update access list</button>
                    </form>
                    <form class="form-inline" action="/hsapi/_internal/{{ cm.short_id }}/change-permissions/" method="POST" style="padding-top:0.3em">
                            {% csrf_token %}
                            <div class="form-group">
                                <label for="">Add user (first, last, email, or username)</label>
                            <input name="t" value="add_edit_user" type="hidden"/>
                            {{ add_edit_user_form.user }}
                                <button type="submit" class="btn btn-primary">Add</button>
                            </div>

                    </form>
                  </div>
                </div>
              </div>

              <div class="panel panel-default">
                <div class="panel-heading">
                  <h4 class="panel-title">
                    <a data-toggle="collapse" data-parent="#accordion" href="#collapseThree">
                      Research groups that can edit the content of this resource
                    </a>
                  </h4>
                </div>
                <div id="collapseThree" class="panel-collapse collapse">
                  <div class="panel-body">
                    <form action="/hsapi/_internal/{{ cm.short_id }}/change-permissions/" method="POST">
                            {% csrf_token %}
                            <small>Hold down "Control", or "Command" on a Mac, to select more than one.</small>
                            <select name="designees" id="edit_groups-select" multiple class="form-control" size="{{ edit_groups.count }}">
                                {% for u in edit_groups %}
                                    <option value="{{ u.pk }}" {% if u in edit_groups %}selected{% endif %}>{{ u }}</option>
                                {% endfor %}
                            </select>
                            <input name="t" value="edit_groups" type="hidden"/>
                            <button type="submit" class="btn btn-primary btn-block">Update access list</button>
                    </form>
                  <form class="form-inline" action="/hsapi/_internal/{{ cm.short_id }}/change-permissions/" method="POST" style="padding-top:0.3em">
                            {% csrf_token %}
                            <div class="form-group">
                                <label for="">Add group by name</label>
                            <input name="t" value="add_edit_group" type="hidden"/>
                            {{ add_edit_group_form.user }}
                                <button type="submit" class="btn btn-primary">Add</button>
                            </div>

                        </form>
                  </div>
                </div>
              </div>

              {% if not cm.public %}
              <div class="panel panel-default">
                <div class="panel-heading">
                  <h4 class="panel-title">
                    <a data-toggle="collapse" data-parent="#accordion" href="#collapseFour">
                      Users who can view and download the resource
                    </a>
                  </h4>
                </div>
                <div id="collapseFour" class="panel-collapse collapse">
                  <div class="panel-body">
                    <form action="/hsapi/_internal/{{ cm.short_id }}/change-permissions/" method="POST">
                        {% csrf_token %}
                        <small>Hold down "Control", or "Command" on a Mac, to select more than one.</small>
                        <select name="designees" id="view_users-select" multiple class="form-control" size="{{ view_users.count }}">
                            {% for u in view_users %}
                                <option value="{{ u.pk }}" {% if u in view_users %}selected{% endif %}>{{ u|best_name }}</option>
                            {% endfor %}
                        </select>
                        <input name="t" value="view_users" type="hidden"/>
                        <button type="submit" class="btn btn-primary btn-block">Update access list</button>
                    </form>
                  <form class="form-inline" action="/hsapi/_internal/{{ cm.short_id }}/change-permissions/" method="POST" style="padding-top:0.3em">
                            {% csrf_token %}
                            <div class="form-group">
                                <label for="">Add user (first, last, email, or username)</label>
                            <input name="t" value="add_view_user" type="hidden"/>
                            {{ add_view_user_form.user }}
                                <button type="submit" class="btn btn-primary">Add</button>
                            </div>

                        </form>
                  </div>
                </div>
              </div>

              <div class="panel panel-default">
                <div class="panel-heading">
                  <h4 class="panel-title">
                    <a data-toggle="collapse" data-parent="#accordion" href="#collapseFive">
                      Research groups that can view and download the resource
                    </a>
                  </h4>
                </div>
                <div id="collapseFive" class="panel-collapse collapse">
                  <div class="panel-body">
                    <form action="/hsapi/_internal/{{ cm.short_id }}/change-permissions/" method="POST">
                        {% csrf_token %}
                        <small>Hold down "Control", or "Command" on a Mac, to select more than one.</small>
                        <select name="designees" id="view_groups-select" multiple class="form-control" size="{{ view_groups.count }}">
                            {% for u in view_groups %}
                                <option value="{{ u.pk }}" {% if u in view_groups %}selected{% endif %}>{{ u }}</option>
                            {% endfor %}
                        </select>
                        <input name="t" value="view_groups" type="hidden"/>
                        <button type="submit" class="btn btn-primary btn-block">Update access list</button>
                    </form>
                  <form class="form-inline" action="/hsapi/_internal/{{ cm.short_id }}/change-permissions/" method="POST" style="padding-top:0.3em">
                            {% csrf_token %}
                            <div class="form-group">
                                <label for="">Add group by name</label>
                            <input name="t" value="add_view_group" type="hidden"/>
                            {{ add_view_group_form.user }}
                                <button type="submit" class="btn btn-primary">Add</button>
                            </div>

                        </form>
                  </div>
                </div>
              </div>
              {% endif %}
            </div>
            {% endif %}

        </div>
    </div>


    {% if keywords %}
        <div class="content-block">
            <h3>Keywords</h3>
            <p id="keywords">{{ keywords }}</p>
            <div class="tags">
                <ul id="list-keywords" class="tag-list custom-well">
                </ul>
            </div>
        </div>
    {% endif %}


    <div>
        <h3>Content</h3>
        <div class="custom-well">
{#            {% block extra_content %}#}
{#            {% endblock %}#}
            <div class="table-container">
                <table class="table-plain">
                    {% for f in cm.files.all %}
                        {#======= Modal window begins =======#}
                        <div class="modal fade" id="delete-resource-file-{{f.pk}}" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                          <div class="modal-dialog">
                            <div class="modal-content">
                              <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                                <h4 class="modal-title">Confirm file deletion</h4>
                              </div>
                              <div class="modal-body">
                                  This will delete the file from the resource. Consider saving a copy if it is important to you.
                              </div>
                              <div class="modal-footer">
                                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                                <a type="button" class="btn btn-danger" href="/hsapi/_internal/{{ cm.short_id }}/delete-resource-file/{{f.pk}}/">Delete</a>
                              </div>
                            </div>
                          </div>
                        </div>
                        {#======= Modal window ends =======#}

                        <tr>
                            <td>
                                <span class="glyphicon glyphicon-file file-icon"></span>
                                <span>
                                    <span class="label-file-name">{{ f.resource_file.name|slice:"33:" }}</span>
                                    <p class="label-file-size">{{ f.resource_file.size|filesizeformat }}</p>
                                </span>
                            </td>
            {#                    <td>{% if preview %}<a class="btn btn-info btn-block" href="{{ preview }}">Preview</a>{% endif %}</td>#}
                            <td>
                                {% if page.perms.change %}
                                    <a href="{{ f.resource_file.url }}"><span data-toggle="modal" data-target="#delete-resource-file-{{f.pk}}" data-placement="auto" title="Delete" class="glyphicon glyphicon-remove-circle icon-button btn-remove"></span></a>
                                {% endif %}
                                <a href="{{ f.resource_file.url }}"><span data-toggle="tooltip" data-placement="auto" title="Download" class="glyphicon glyphicon-download icon-button btn-download"></span></a>
                                {% if preview %}
                                    <a href="{{ f.resource_file.url }}"><span data-toggle="tooltip" data-placement="auto" title="Preview" class="glyphicon glyphicon-eye-open icon-button"></span></a>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                </table>
            </div>
            <!-- Buttons -->
            {% for b in cm.bags.all %}
                <a type="button" class="btn btn-default" href="{{ bag.bag.url }}">
                    <span class="glyphicon glyphicon-download-alt">
                        <span class="button-label">Download All ({{ b.bag.size|filesizeformat }})</span>
                    </span>
                </a>
            {% endfor %}

    {#                      {% if page.perms.change and resource_type != "Geographic Raster Resource" %}#}
            {% if page.perms.change %}
    {#                        <td><button class="btn btn-success"  data-toggle="modal" data-target="#add-file-dialog" multiple="multiple">Add file</button></td>#}
                <td><a type="button" class="btn btn-success" data-toggle="modal" data-target="#add-file-dialog" multiple="multiple">
                    <span class="glyphicon glyphicon-plus"><span class="button-label"> Add file...</span></span>
                </a></td>
            {% endif %}
        </div>
     </div>


    <!-- === Tabs begin === -->
        <div class="tab-elements">
		<div class="panel-tabs">
			<ul class="nav nav-tabs">
				<li class="active">
					<a href="#contactTab" data-toggle="tab">
						<span class="glyphicon glyphicon-user"> </span>
                        Contact
					</a>
				</li>
				<li>
					<a href="#spatialTab" data-toggle="tab">
						<span class="glyphicon glyphicon-globe"></span>
						Spatial
                    </a>
				</li>

                <li>
					<a href="#relatedResourcesTab" data-toggle="tab">
						<span class="glyphicon glyphicon-book"></span>
						Related Resources
                    </a>
				</li>
                <li>
					<a href="#resourceSpecificTab" data-toggle="tab">
						<span class="glyphicon glyphicon-folder-close"></span>
						Resource Specific
                    </a>
				</li>
                <li>
					<a href="#systemMetadataTab" data-toggle="tab">
						<span class="glyphicon glyphicon-cog"></span>
						System Metadata
                    </a>
				</li>
                <li>
					<a href="#commentsTab" data-toggle="tab">
						<span class="glyphicon glyphicon-comment"></span>
						Comments
                    </a>
				</li>
			</ul>
		</div>
		<div class="tabs-body">
			<!-- Tab panes -->
			<div class="tab-content">
                <!-- ========= CONTACT TAB ========= -->
				<div class="tab-pane active" id="contactTab">
                    <div class="division-title"><p>Creators</p></div>
                    <div>
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>HydroShare User Identifier</th>
                                    <th>Organization</th>
                                    <th>Address</th>
                                    <th>Phone</th>
                                    <th>Home page</th>
                                </tr>
                            </thead>

                            <tbody>
                                {% for cr in creators %}
                                    <tr>
                                        <td>{{ cr.name }}</td>
                                        <td>{{ cr.description }}</td>
                                        <td>{{ cr.organization }}</td>
                                        <td>{{ cr.address }}</td>
                                        <td>{{ cr.phone }}</td>
                                        <td>{{ cr.homepage }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% if contributors %}
                            <hr>
                            <div class="division-title"><p>Contributors</p></div>
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>HydroShare User Identifier</th>
                                        <th>Organization</th>
                                        <th>Address</th>
                                        <th>Phone</th>
                                        <th>Home page</th>
                                    </tr>
                                </thead>

                                <tbody>
                                    {% for cont in contributors %}
                                        <tr>
                                            <td>{{ cont.name }}</td>
                                            <td>{{ cont.description }}</td>
                                            <td>{{ cont.organization }}</td>
                                            <td>{{ cont.address }}</td>
                                            <td>{{ cont.phone }}</td>
                                            <td>{{ cont.homepage }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        {% endif %}
                    </div>
				</div>
                <!-- ========= SPATIAL TAB ========= -->
				<div class="tab-pane" id="spatialTab">
					<table class="table">
						<tbody>
                            {% if spatial_coverage.type == 'point' %}
                                {% if spatial_coverage.name %}
                                    <tr>
                                        <th scope="row" class="dataset-label">Place/Area Name:</th>
                                        <td class="dataset-details">{{ spatial_coverage.name}}</td>
                                    </tr>
                                {% endif %}
                                {% if spatial_coverage.projection %}
                                    <tr>
                                        <th scope="row" class="dataset-label">Coordinate System/Geographic Projection:</th>
                                        <td class="dataset-details">{{ spatial_coverage.projection}}</td>
                                    </tr>
                                {% endif %}
                                {% if spatial_coverage.east %}
                                    <tr>
                                        <th scope="row" class="dataset-label">Longitude:</th>
                                        <td class="dataset-details">{{ spatial_coverage.east}}</td>
                                    </tr>
                                {%  endif %}
                                {% if spatial_coverage.north %}
                                    <tr>
                                        <th scope="row" class="dataset-label">Latitude:</th>
                                        <td class="dataset-details">{{ spatial_coverage.north}}</td>
                                    </tr>
                                {%  endif %}
                                {% if spatial_coverage.units %}
                                    <tr>
                                        <th scope="row" class="dataset-label">Coordinate Units:</th>
                                        <td class="dataset-details">{{ spatial_coverage.units}}</td>
                                    </tr>
                                {%  endif %}
                            {% else %}
                                {% if spatial_coverage.name %}
                                    <tr>
                                        <th scope="row" class="dataset-label">Place/Area Name:</th>
                                        <td class="dataset-details">{{ spatial_coverage.name}}</td>
                                    </tr>
                                {% endif %}
                                {% if spatial_coverage.projection %}
                                    <tr>
                                        <th scope="row" class="dataset-label">Coordinate System/Geographic Projection:</th>
                                        <td class="dataset-details">{{ spatial_coverage.projection}}</td>
                                    </tr>

                                {% endif %}
                                {% if spatial_coverage.northlimit %}
                                    <tr>
                                        <th scope="row" class="dataset-label">North Latitude:</th>
                                        <td class="dataset-details">{{ spatial_coverage.northlimit }}</td>
                                    </tr>
                                {% endif %}
                                {% if spatial_coverage.eastlimit %}
                                    <tr>
                                        <th scope="row" class="dataset-label">East Longitude:</th>
                                        <td class="dataset-details">{{ spatial_coverage.eastlimit }}</td>
                                    </tr>
                                {% endif %}
                                {% if spatial_coverage.southlimit %}
                                    <tr>
                                        <th scope="row" class="dataset-label">South Latitude:</th>
                                        <td class="dataset-details">{{ spatial_coverage.southlimit }}</td>
                                    </tr>

                                {% endif %}
                                {% if spatial_coverage.westlimit %}
                                    <tr>
                                        <th scope="row" class="dataset-label">West Longitude:</th>
                                        <td class="dataset-details">{{ spatial_coverage.westlimit}}</td>
                                    </tr>
                                {% endif %}
                                {% if spatial_coverage.units %}
                                    <tr>
                                        <th scope="row" class="dataset-label">Coordinate Units:</th>
                                        <td class="dataset-details">{{ spatial_coverage.units}}</td>
                                    </tr>
                                {%  endif %}
                            {% endif %}
						</tbody>
					</table>
				</div>

                <!-- ========= RELATED RESOURCES TAB ========= -->
                <div class="tab-pane" id="relatedResourcesTab">
					<table class="table">
						<tbody>
                        {% for source in sources %}
							<tr>
								<th scope="row" class="dataset-label">Derived From:</th>
								<td class="dataset-details">{{ source.derived_from }}</td>
							</tr>
                        {%  endfor %}
                        {% for relation in relations %}
                            <tr>
								<th scope="row" class="dataset-label">{{ relation.type }}:</th>
								<td class="dataset-details">{{ relation.value }}</td>
							</tr>
                        {%  endfor %}
						</tbody>
					</table>
				</div>
                <!-- ========= RESOURCE SPECIFIC TAB ========= -->
                <div class="tab-pane" id="resourceSpecificTab">
{#                    TODO: resource specific fields#}
{#                    <table class="table">#}
{#                        {% for term in dublin_core %}#}
{#                            {% ifnotequal term|dcterm 'Title' %}#}
{#                                <tr>#}
{#                                    <th>{{ term|dcterm }}</th>#}
{#                                    <td>{{ term.content }}</td>#}
{#                                </tr>#}
{#                            {% endifnotequal %}#}
{#                        {% endfor %}#}
{#                    </table>#}
{#                    {% if page.perms.change %}#}
{#                        <button class="btn btn-primary" id="add-dcterm" data-toggle="modal" data-target="#add-dcterm-dialog">Add metadata term</button>#}
{#                    {% endif %}#}
				</div>
                <!-- ========= SYSTEM METADATA TAB ========= -->
                <div class="tab-pane" id="systemMetadataTab">
					<table class="table">
						<tbody>
							<tr>
								<th scope="row" class="dataset-label">Language:</th>
								<td class="dataset-details">{{ language }}</td>
							</tr>
                            <tr>
								<th scope="row" class="dataset-label">Resource Type:</th>
								<td class="dataset-details">{{ resource_type }}</td>
							</tr>
                            <tr>
								<th scope="row" class="dataset-label">Owner:</th>
								<td class="dataset-details">{{ cm.user|contact|safe }}</td>
							</tr>
                            <tr>
								<th scope="row" class="dataset-label">Added on:</th>
								<td class="dataset-details">{{ cm.created|date }}</td>
							</tr>

                            {%  if temporal_coverage %}
                                <tr>
                                    <th scope="row" class="dataset-label">Start Date:</th>
                                    <td class="dataset-details">{{ temporal_coverage.start_date }}</td>
                                </tr>
                                <tr>
                                    <th scope="row" class="dataset-label">End Date:</th>
                                    <td class="dataset-details">{{ temporal_coverage.end_date }}</td>
                                </tr>
                            {%  endif %}

                            <tr>
								<th scope="row" class="dataset-label">Last updated:</th>
								<td class="dataset-details">{{ cm.updated|date }}, by {% if cm.last_changed_by %}{{ cm.last_changed_by|contact|safe }}{% endif %}</td>
							</tr>
                            <tr>
								<th scope="row" class="dataset-label">Permalink:</th>
								<td class="dataset-details"><a id="permalink" href="http://{{ request.get_host }}/resource/{{ cm.short_id }}/">http://{{ request.get_host }}/resource/{{ cm.short_id }}/</a></td>
							</tr>

                            {% if cm.doi %}
                                <tr>
								    <th scope="row" class="dataset-label">DOI:</th>
								    <td class="dataset-details"><a id="permalink" href="http://{{ request.get_host }}/r/doi/{{ cm.doi }}/">{{ cm.doi }}</a></td>
							    </tr>
                            {% elif page.perms.change %}
                                {% comment %}
                                <tr>
								    <th scope="row" class="dataset-label">DOI:</th>
								    <td class="dataset-details"><button class='btn btn-danger' data-toggle="modal" data-target="#submit-for-publication-dialog">Submit for publication</button></td>
							    </tr>
							    {% endcomment %}
                            {% endif %}
                            {% if cm.public %}
                                <tr>
								    <th scope="row" class="dataset-label">Sharing Status:</th>
								    <td class="dataset-details text-success">Public</td>
							    </tr>
                            {% else %}
                                <tr>
								    <th scope="row" class="dataset-label">Sharing Status:</th>
								    <td class="dataset-details text-danger">Private</td>
							    </tr>
                            {% endif %}
{#                            <tr>#}
{#                                <th scope="row" class="dataset-label">Metadata Status:</th>#}
{##}
{#                                {%  if metadata_status == "Insufficient to make public" %}#}
{#                                    <td class="dataset-details text-danger">{{ metadata_status }}</td>#}
{#                                {%  else %}#}
{#                                    <td class="dataset-details text-success">{{ metadata_status }}</td>#}
{#                                {%  endif %}#}
{#                            </tr>#}
						</tbody>
					</table>
				</div>
                <!-- ========= COMMENTS  TAB ========= -->
                <div class="tab-pane" id="commentsTab">
                    {% if not metadata_form %}
                        {% comments_for cm %}
                    {% endif %}
                </div>
			</div>
		</div>
	</div>
{% endif %}
    <!-- ==== Tabs end ==== -->

    <div class="row">
        <div class="col-md-12">
            <div class="form-group">
               {% if metadata_form %}
                    <button id="metadata-show-toggle" type="button" class="btn btn-primary" onclick="toggle_metadata_display()">Collapse All</button>
                    {% crispy metadata_form %}
               {% else %}
                   <div>
                       {% if not keywords or not abstract%}
                            <table class="table table-condensed" style="margin-top: 2px; border: 2px solid red">
                                <tr style="color: red"><td><h4>Data for the following required elements are missing:</h4></td></tr>
                                {% if not abstract %}
                                    <tr><td>Abstract</td></tr>
                                {% endif %}
                                {% if not keywords %}
                                    <tr><td>Keywords</td></tr>
                                {% endif %}
                                {% if title|stringformat:"s" == "Untitled resource" %}
                                    <tr><td>Title:Needs to be changed</td></tr>
                                {% endif %}
                            </table>
                       {% endif %}
                   </div>
               {% endif %}

                <div>
                {# TODO: Pabitra to check if this for loop code is relevant #}
                {% for attr, val_dict in core_metadata.items %}
                    <h5>{{ attr }}</h5>
                    <table class="table table-condensed">
                        {% for subattr, subval in val_dict.items %}
                        <tr>
                            <th>{{ subattr }}</th>
                            <td>{{ subval }}</td>
                        </tr>
                        {% endfor %}
                    </table>
                {% endfor %}
                </div>
            </div>
        </div>
    </div>

    {#                #}
    {# dialogs follow #}
    {#                #}

    <!-- Modal -->
    <div class="modal fade" id="submit-for-publication-dialog" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h4 class="modal-title" id="submit-for-publication-title">Submit resource for publication</h4>
          </div>
          <div class="modal-body">
            <p>
                Once you submit the resource for publication it cannot be changed again.  This will assign a DOI to the
                resource as it stands now and mark it as permanent.  To make any changes after this, you <strong>must</strong>
                create a brand new resource. Click "Publish" if you really intend to do this.
            </p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
            <a type="button" class="btn btn-danger" href="/hsapi/_internal/{{ cm.short_id }}/publish/">Publish</a>
          </div>
        </div>
      </div>
    </div>


    <div class="modal fade" id="delete-resource-dialog" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h4 class="modal-title" id="delete-resource-title">Delete Resource</h4>
          </div>
          <div class="modal-body">
                <strong>THIS IS A PERMANENT ACTION. </strong>
                <ul>
                  <li>This will delete the resource file.</li>
                  <li>A copy of your resource file will not be retained by Hydroshare.</li>
                  <li>We highly recommend that you download the latest copy of your resource file before confirming this action.</li>
                </ul>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
            <a type="button" class="btn btn-danger" href="/hsapi/_internal/{{ cm.short_id }}/delete-resource/">Delete</a>
          </div>
        </div>
      </div>
    </div>
        <!-- Modal -->
    <div class="modal fade" id="add-dcterm-dialog" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
        <form action="/hsapi/_internal/{{ cm.short_id }}/add-metadata/">

          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h4 class="modal-title" id="myModalLabel">Add metadata term</h4>
          </div>
          <div class="modal-body">
                    {% csrf_token %}

                    {{ dcterm_frm|crispy }}

          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary">Save changes</button>
          </div>
        </form>
        </div>
      </div>
    </div>
        <!-- Modal -->
    <div class="modal fade" id="add-reference-dialog" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <form action="/hsapi/_internal/{{ cm.short_id }}/add-citation/">

          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h4 class="modal-title" id="myModalLabel">Add reference</h4>
          </div>
          <div class="modal-body">
                  {% csrf_token %}
                  <div class="form-group">
                      <label for="add-citation-input">Citation text:</label>
                      <textarea class="form-control" name="content" id="add-citation-input" cols="30" rows="10"></textarea>
                  </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary">Save changes</button>
          </div>
          </form>
        </div>
      </div>
    </div>

    <div class="modal fade" id="add-file-dialog" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <form action="/hsapi/_internal/{{ cm.short_id }}/add-file-to-resource/" method="POST" enctype="multipart/form-data">

          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h4 class="modal-title" id="myModalLabel">Add file to resource</h4>
          </div>
          <div class="modal-body">
                  {% csrf_token %}
                  <div class="form-group">
                      <label for="add-citation-input">Select files:</label>
                      <input type="file" name="files" id="add-file-input" multiple/>
                  </div>

          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary">Save changes</button>
          </div>
          </form>
        </div>
      </div>
    </div>


{% endwith %}

{% block extra_js %}
    <script type="text/javascript">
    $(function() {
    });

    function toggle_metadata_display(){
        if ($("#metadata-show-toggle").text() === 'Show All'){
            $("#metadata-show-toggle").text('Collapse All');
            $('.accordion-body:not(".in")').collapse('show');
        }
        else {
            $("#metadata-show-toggle").text('Show All');
            $('.accordion-body.in').collapse('hide');
        }
    }

    function metadata_update_ajax_submit(form_id){
            $alert_success = '<div class="alert alert-success" id="success-alert"> \
                <button type="button" class="close" data-dismiss="alert">x</button> \
                <strong>Success! </strong> \
                Metadata updated.\
            </div>'

            $alert_error = '<div class="alert alert-danger" id="error-alert"> \
                <button type="button" class="close" data-dismiss="alert">x</button> \
                <strong>Error! </strong> \
                Metadata updated failed.\
            </div>'

            $form=$('#' + form_id);
            var datastring = $form.serialize();
            $.ajax({
                type: "POST",
                url: $form.attr('action'),
                dataType: 'html',
                data: datastring,
                success: function(result)
                {
                    /* The div contains now the updated form */
                    //$('#' + form_id).html(result);
                    console.log(result);
                    json_response = JSON.parse(result);
                    console.log(json_response);
                    if (json_response.status === 'success')
                    {
                        $form.find("button").hide();
                        if (json_response.hasOwnProperty('element_id')){
                            form_update_action = $form.attr('action');
                            res_short_id = form_update_action.split('/')[3];
                            update_url = "/hsapi/_internal/" + res_short_id + "/" + json_response.element_name +"/" + json_response.element_id + "/update-metadata/"
                            $form.attr('action', update_url);

                        }
                        if (json_response.hasOwnProperty('element_name')){
                            if(json_response.element_name === 'title'){
                                $res_title = $(".section-header").find("span").first();
                                field_name_value = $res_title.text();
                                console.log(field_name_value);
                                updated_title = $form.find("#id_value").val();
                                $res_title.text(updated_title);
                            }
                        }

                        if (json_response.hasOwnProperty('metadata_status')){
                            if(json_response.metadata_status !== $('#metadata-status').text()){
                                $('#metadata-status').text(json_response.metadata_status);
                                if(json_response.metadata_status == "Sufficient to make public")
                                {
                                    customAlert("Metadata Status:Sufficient to make public", 3000);
                                    $('#metadata-status').removeClass('text-danger');
                                    $('#metadata-status').addClass('text-success');
                                    $('#id_sharing #make-public').remove();
                                    $('#id_sharing').append('<input name="t" type="hidden" value="make_public"/><button id="make-public" type="submit" class="btn btn-danger">Make public</button>');
                                }
                                else{
                                    $('#metadata-status').removeClass('text-success');
                                    $('#metadata-status').addClass('text-danger');
                                    $('#id_sharing #make-public').hide();
                                    $('#id_sharing #make-private').hide();
                                    $('#sharing-status').text('Private');
                                }
                            }
                        }

                        $('#' + form_id).before($alert_success);
                        $('#' + form_id).closest('div').find('#error-alert').each(function(){
                            this.remove();
                        });
                        $(".alert-success").fadeTo(2000, 500).slideUp(1000, function(){

                            $(".alert-success").alert('close');
                        });
                    }
                    else{
                        $('#' + form_id).before($alert_error);

                    }
                },
                error: function(XMLHttpRequest, textStatus, errorThrown)
                {
                    $('#' + form_id).before($alert_error)
                    $(".alert-error").fadeTo(2000, 500).slideUp(1000, function(){
                        $(".alert-error").alert('close');
                    });
                }
            });

            //don't submit the form
            return false;
        }

    function customAlert(msg,duration)
    {
        var el = document.createElement("div");
        var top = ($(window).height() / 2) - 25;
        var left = ($(window).width() / 2) - 150;
        var style = "position:fixed;top:" + top + "px;left:" + left + "px;background-color:lightgreen; width:300px; height:50px; text-align:center; line-height:50px";
        el.setAttribute("style",style);
        el.innerHTML = msg;
        setTimeout(function(){
        el.parentNode.removeChild(el);
    },duration);
        document.body.appendChild(el);
    }

    $(document).ready(function () {
        if($("#id_type_1").is(':checked')){ //box type coverage
             $("#div_id_north").hide();
             $("#div_id_east").hide();
             $("#div_id_elevation").hide();
        }
        if($("#id_type_2").is(':checked')){ // point type coverage
            $("#div_id_northlimit").hide();
            $("#div_id_eastlimit").hide();
            $("#div_id_southlimit").hide();
            $("#div_id_westlimit").hide();
            $("#div_id_uplimit").hide();
            $("#div_id_downlimit").hide();
        }
        if ($("input:button[value='Delete creator']").length == 1){
            $("input:button[value='Delete creator']").first().hide();
        }
        // disable all save changes button on load
        $("form").each(function(){
            $save_button = $(this).find("button").first();
            if ($save_button.text() === "Save changes"){
                $save_button.hide();
            }
        })

        // open all metadata collasible elements on page load
        $('.accordion-body:not(".in")').collapse('show');


        $("#select_license").on('change', function(){
            var value = this.value;
            if (value === "other"){
                $(this).closest("form").find("#id_statement").first().text("");
                $(this).closest("form").find("#id_url").first().attr('value', "");
                $(this).closest("form").find("#id_statement").first().attr('readonly', false);
                $(this).closest("form").find("#id_url").first().attr('readonly', false);
            }
            else{
                var text = $(this).find('option:selected').text();
                text = "This resource is shared under the " + text + ".";
                $(this).closest("form").find("#id_statement").first().text(text);
                $(this).closest("form").find("#id_url").first().attr('value', value);
                $(this).closest("form").find("#id_statement").first().attr('readonly', true);
                $(this).closest("form").find("#id_url").first().attr('readonly', true);
            }

        });

        // set the selected license in the select license dropdown
        var value_exists = false;
        $("#select_license option").each(function(){
            if (this.value == $("#id_url").attr('value')){
                $("#select_license").val($("#id_url").attr('value'));
                value_exists = true;
                return;
            }
        })

        if (value_exists == false){
            // set the selected license type to 'other'
            $("#select_license").val('other');
            console.log($("#select_license").attr('readonly'));
            if($("#select_license").attr('readonly') == undefined){
                $("#select_license").closest("form").find("#id_statement").first().attr('readonly', false);
                $("#select_license").closest("form").find("#id_url").first().attr('readonly', false);
            }
            else{
                $("#select_license").attr('style', "background-color:white;");
                $("#select_license").closest("form").find("#id_statement").first().attr('readonly', true);
                $("#select_license").closest("form").find("#id_url").first().attr('readonly', true);
            }
        }

        // show "Save changes" button when form editing starts
        $(".form-control").each(function(){
            $(this).on('input', function(e){
                //$(this).css('border-color', 'gray');
                $(this).closest("form").find("button").show();
            });
            $(this).on('change', function(e){
                //$(this).css('border-color', 'gray');
                $(this).closest("form").find("button").show();
            });
        })
        $(".dateinput").each(function(){
            $(this).datepicker({
                format: 'mm-dd-yyyy',
                changeMonth: true,
                changeYear: true
             });

            $(this).on('change', function(){
                $(this).closest("form").find("button").show();
            });
        })
        // Code adapted from http://djangosnippets.org/snippets/1389/
        function updateElementIndex(el, prefix, ndx) {
            var id_regex = new RegExp('(' + prefix + '-\\d+-)');
            var replacement = prefix + '-' + ndx + '-';
            if ($(el).attr("for")) $(el).attr("for", $(el).attr("for").replace(id_regex,
            replacement));
            if (el.id) el.id = el.id.replace(id_regex, replacement);
            if (el.name) el.name = el.name.replace(id_regex, replacement);
        }
        function deleteForm(btn, prefix) {
            var formCount = parseInt($('#id_' + prefix + '-TOTAL_FORMS').val());
            if (formCount > 1) {
                // Delete the item/form
                $(btn).parents('.item').slideUp(300);
                $(btn).parents('.item').remove();
                var forms = $("#" + prefix + ' .item'); // Get all the forms
                // Update the total number of forms (1 less than before)
                $('#id_' + prefix + '-TOTAL_FORMS').val(forms.length);
                var i = 0;
                // Go through the forms and set their indices, names and IDs
                for (formCount = forms.length; i < formCount; i++) {
                    $(forms.get(i)).children().children().each(function () {
                        if ($(this).attr('type') == 'text') updateElementIndex(this, prefix, i);
                        if($(this).is('input')) updateElementIndex(this, prefix, i);
                    });
                    $(forms.get(i)).find('input').each(function (){
                        updateElementIndex(this, prefix, i);
                    })
                }
            } // End if
            else {
                if (prefix == 'creators'){
                    alert("Resource needs to have at least one creator!");
                }
            }
            return false;
        }
        function addForm(btn, prefix) {
            var formCount = parseInt($('#id_' + prefix + '-TOTAL_FORMS').val());
            // You can only submit a maximum of 10 todo items
            if (formCount < 10) {
                // Clone a form (without event handlers) from the first form
                var row = $("#" + prefix + " .item:first").clone(false).get(0);
                // Insert it after the last form
                $(row).removeAttr('id').hide().insertAfter("#" + prefix + " .item:last").slideDown(300);
                // Remove the bits we don't want in the new row/form
                // e.g. error messages
                $(".errorlist", row).remove();
                $(row).children().removeClass("error");
                $(row).find(".item_link:not(:first)").remove();
                // Relabel or rename all the relevant bits of the main form
                $(row).children().children().each(function () {
                    updateElementIndex(this, prefix, formCount);
                    $(this).val("");
                });
                // Relabel or rename all the relevant bits of the child form
                var link_prefix = prefix + '_links'
                $(row).find("*").each(function () {
                    updateElementIndex(this, link_prefix, formCount);
                    if ($(this).attr("id")){
                        if($(this).attr("id").substr(-6) !== "_FORMS"){
                            $(this).val("");
                        }
                        else{
                            if($(this).attr("id").substr(-11) === "TOTAL_FORMS"){
                                $(this).val("1");
                            }
                        }
                    }
                    else{
                        $(this).val("");
                    }
                });
                $(row).find('input').each(function () {
                    updateElementIndex(this, prefix, formCount);
                    if ($(this).attr('type') == 'button'){
                        if (prefix === 'creator'){
                            $(this).attr('value', 'Delete creator');
                        }
                        else if(prefix === 'contributor'){
                            $(this).attr('value', 'Delete contributor');
                        }
                        else{
                            $(this).attr('value', 'Delete');
                        }
                    }
                    if ($(this).attr('type') == 'submit'){
                        $(this).attr('value', 'Save');
                    }
                })
                // Add an event handler for the delete item/form link
                $(row).find(".delete-creator").click(function () {
                    return deleteForm(this, prefix);
                });
                $(row).find(".delete-contributor").click(function () {
                    return deleteForm(this, prefix);
                });
                $(row).find("#addLinkCreator").click(function () {
                    return addLink(this, "creator");
                });
                // Add an event handler for the delete item/form link
                $(row).find(".delete-link-creator").click(function () {
                    return deleteLink(this, prefix);
                });
                $(row).find(".delete-link-contributor").click(function () {
                    return deleteLink(this, prefix);
                });
                // Update the total form count
                $("#id_" + prefix + "-TOTAL_FORMS").val(formCount + 1);
            } // End if
            else {
                alert("Sorry, you can only enter a maximum of ten items.");
            }
            return false;
        }
        function deleteLink(btn, prefix) {
            var link_form_input = $(btn).parents('.item').children('input:first');
            var id = $(link_form_input).attr('id');
            var link_formset_index = id.split("-")[1];
            var formCount = parseInt($('#id_' + prefix + '_links-' + link_formset_index+ '-TOTAL_FORMS').val());
            if (formCount > 1) {
                // Delete the item/form
                $(btn).parents('.item_link').slideUp(300);
                $(btn).parents('.item_link').remove();
                var forms = $("#" + prefix + ' .item_link'); // Get all the forms
                // Update the total number of forms (1 less than before)
                var update_prefix = prefix + '_links-' + link_formset_index;
                $('#id_' + update_prefix + '-TOTAL_FORMS').val(forms.length);
                var i = 0;
                // Go through the forms and set their indices, names and IDs
                for (formCount = forms.length; i < formCount; i++) {
                    $(forms.get(i)).children().children().each(function () {
                        if ($(this).attr('type') == 'text') updateElementIndex(this, update_prefix, i);
                        if($(this).is('input')) updateElementIndex(this, update_prefix, i);
                    });
                    $(forms.get(i)).find('input').each(function (){
                        updateElementIndex(this, update_prefix, i);
                    })
                }
            } // End if

            return false;
        }
        function addLink(btn, prefix) {
            var link_form_input = $(btn).parents('.item').children('input:first');
            var id = $(link_form_input).attr('id');
            var link_formset_index = id.split("-")[1];
            var formCount = parseInt($('#id_' + prefix + '_links-' + link_formset_index + '-TOTAL_FORMS').val());
            // You can only submit a maximum of 10 todo items
            if (formCount < 10) {
                // Clone a form (without event handlers) from the first form
                //var row = $("#" + prefix + " .item_link:first").clone(false).get(0);
                var row = $(btn).parents(".item").find(".item_link:last").clone(false).get(0);
                // Insert it after the last form
                $(row).removeAttr('id').hide().insertAfter("#" + prefix + " .item_link:last").slideDown(300);
                // Remove the bits we don't want in the new row/form
                // e.g. error messages
                $(".errorlist", row).remove();
                $(row).children().removeClass("error");
                var update_prefix = prefix + '_links-' + link_formset_index;
                // Relabel or rename all the relevant bits
                $(row).find('*').each(function (){
                    updateElementIndex(this, update_prefix, formCount);
                    $(this).val("");
                })

                $(row).find('button').each(function () {
                    updateElementIndex(this, update_prefix, formCount);
                    if ($(this).attr('type') == 'button'){
                        $(this).text('Delete Link');
                    }

                })
                // Add an event handler for the delete item/form link
                $(row).find(".delete-link-creator").click(function () {
                    return deleteLink(this, prefix);
                });
                $(row).find(".delete-link-contributor").click(function () {
                    return deleteLink(this, prefix);
                });
                // Update the total form count
                $("#id_" + update_prefix + "-TOTAL_FORMS").val(formCount + 1);
            } // End if
            else {
                alert("Sorry, you can only enter a maximum of ten links.");
            }
            return false;
        }



        // Register the click event handlers
        $("#addCreator").click(function () {
            return addForm(this, "creator");
        });
        $(".delete-creator").click(function () {
            return deleteForm(this, "creator");
        });
        $("#addContributor").click(function () {
            return addForm(this, "contributor");
        });
        $("#addLinkCreator").click(function () {
            return addLink(this, "creator");
        });
        $(".delete-contributor").click(function () {
            return deleteForm(this, "contributors");
        });
        $(".delete-link-contributor").click(function () {
            return deleteLink(this, "contributors");
        });
        $(".delete-link-creator").click(function () {
            return deleteLink(this, "creator");
        });

        $("#addSource").click(function () {
            return addForm(this, "source");
        });

        $("form input:radio").change(function () {
            if ($(this).val() == "point") {
                //alert('you select the point radio button');
                $("#div_id_north").show();
                $("#div_id_east").show();
                $("#div_id_elevation").show();
                $("#div_id_northlimit").hide();
                $("#div_id_eastlimit").hide();
                $("#div_id_southlimit").hide();
                $("#div_id_westlimit").hide();
                $("#div_id_uplimit").hide();
                $("#div_id_downlimit").hide();
            }
            else {
                //alert('you select the box radio button');
                $("#div_id_north").hide();
                $("#div_id_east").hide();
                $("#div_id_elevation").hide();
                $("#div_id_northlimit").show();
                $("#div_id_eastlimit").show();
                $("#div_id_southlimit").show();
                $("#div_id_westlimit").show();
                $("#div_id_uplimit").show();
                $("#div_id_downlimit").show();
            }
        });
    });
    </script>
{% endblock %}

{% endblock %}
